<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UaIA</title>
<style>
:root{--bg:#121212;--header:#1e1e1e;--user:#0084ff;--assistant:#2b2b2b}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#eee;display:flex;flex-direction:column;height:100vh}
header{background:var(--header);padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
#chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.bubble{max-width:80%;padding:10px 14px;border-radius:18px;word-wrap:break-word;white-space:pre-wrap;font-size:15px;line-height:1.4}
.user{align-self:flex-end;background:var(--user);color:#fff;border-bottom-right-radius:4px}
.assistant{align-self:flex-start;background:var(--assistant);color:#eee;border-bottom-left-radius:4px}
.typing{width:52px;height:20px;display:flex;align-items:center;justify-content:space-around}
.typing span{width:6px;height:6px;background:#ccc;border-radius:50%;animation:blink 1s infinite alternate}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{from{opacity:.2}to{opacity:1}}
footer{background:var(--header);padding:8px;display:flex;gap:8px;position:sticky;bottom:0}
select,input,button{font-size:15px;border:none;border-radius:20px;padding:10px;background:#2b2b2b;color:#eee}
button{background:var(--user);color:#fff;font-weight:600;cursor:pointer}
#mic{width:48px;padding:0}
input{flex:1;background:#2b2b2b}
@media(max-width:600px){.bubble{max-width:90%}}
</style>
</head>
<body>
<header>
  <span id="username">Não logado</span>
  <button id="logout" style="display:none">Logout</button>
</header>

<main id="chat"></main>

<footer>
  <select id="voiceSel">
    <option value="VOICE_ID_A">Amiga</option>
    <option value="VOICE_ID_B">Executiva</option>
    <option value="VOICE_ID_C">Motivacional</option>
  </select>
  <button id="mic">🎤</button>
  <input id="txt" placeholder="Digite sua mensagem..." autocomplete="off">
  <button id="send">Enviar</button>
</footer>

<script>
const ws=new WebSocket(location.origin.replace(/^http/,'ws'));
let user=null,typingEl=null,assistantBubble=null;
const micBtn=document.getElementById('mic');
const voiceSel=document.getElementById('voiceSel');
voiceSel.value=localStorage.getItem('uaia_voice')||'VOICE_ID_A';
voiceSel.onchange=()=>localStorage.setItem('uaia_voice',voiceSel.value);

// --- Web Speech API ---
let recognition,recognizing=false;
if('webkitSpeechRecognition'in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='pt-BR';
  recognition.interimResults=false;
  recognition.onresult=e=>{
    document.getElementById('txt').value=e.results[0][0].transcript;
    send();
  };
  recognition.onend=()=>{recognizing=false;micBtn.textContent='🎤';};
  micBtn.onclick=()=>{
    if(recognizing){recognition.stop();return;}
    recognition.start();recognizing=true;micBtn.textContent='◼';
  };
}else{micBtn.style.display='none';}

// --- Chat helpers ---
function addBubble(cls,html){
  const div=document.createElement('div');
  div.className='bubble '+cls;
  div.innerHTML=html;
  document.getElementById('chat').appendChild(div);
  div.scrollIntoView();
  return div;
}
function showTyping(){typingEl=addBubble('assistant','<div class="typing"><span></span><span></span><span></span></div>');}
function hideTyping(){if(typingEl){typingEl.remove();typingEl=null;}}
function login(){
  user = localStorage.getItem('uaia_user');
  if(!user){
    user = prompt('Digite seu nome:','visitante_'+Math.floor(Math.random()*1000));
    if(!user) return;
    localStorage.setItem('uaia_user', user);
  }
  document.getElementById('username').textContent=user;
  document.getElementById('logout').style.display='inline';
  ws.send(JSON.stringify({type:'login',user}));
}
document.getElementById('logout').onclick=()=>{
  localStorage.removeItem('uaia_user');
  location.href='usuarios.html';
};
document.getElementById('send').onclick=send;
document.getElementById('txt').addEventListener('keydown',e=>{if(e.key==='Enter')send();});
function send(){
  const txt=document.getElementById('txt');
  const msg=txt.value.trim();
  if(!msg)return;
  addBubble('user',msg);
  ws.send(JSON.stringify({type:'message',content:msg}));
  txt.value='';showTyping();assistantBubble=addBubble('assistant','');
}

// --- ElevenLabs TTS ---
function speak(text){
  const vid=voiceSel.value;
  fetch(`https://api.elevenlabs.io/v1/text-to-speech/${vid}/stream`,{
    method:'POST',
    headers:{
      'xi-api-key':window.ELEVEN_API_KEY||'',
      'Content-Type':'application/json'
    },
    body:JSON.stringify({text,voice_settings:{stability:0.3,similarity_boost:0.9}})
  })
  .then(r=>r.blob())
  .then(b=>{
    const url=URL.createObjectURL(b);
    const audio=new Audio(url);
    audio.play().catch(()=>{
      const btn=document.createElement('button');
      btn.textContent='▶️ Ouvir resposta';
      btn.onclick=()=>audio.play();
      assistantBubble.appendChild(btn);
    });
  });
}

ws.onopen=login;
let assistantText='';
ws.onmessage=e=>{
  const data=JSON.parse(e.data);
  if(data.type==='assistant'){
    hideTyping();
    assistantText+=data.content;
    assistantBubble.innerHTML=assistantText.replace(/\\n/g,'<br>');
    assistantBubble.scrollIntoView();
    clearTimeout(window._speakT);
    window._speakT=setTimeout(()=>{speak(assistantText);assistantText='';},800);
  }
};
</script>
</body>
</html>
